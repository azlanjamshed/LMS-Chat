<!DOCTYPE html>
<html>

<head>
    <title>LMS Chat - Rooms</title>
</head>

<body style="font-family: Arial; max-width: 600px; margin: 50px auto;">
    <h1>ğŸ« LMS Class Chat</h1>
    <div style="background: #e7f3ff; padding: 15px; border-radius: 10px; margin: 20px 0;">
        <h3>ğŸ” Login</h3>
        <input id="loginUsername" placeholder="Username" style="padding: 5px; margin: 5px;" />
        <input id="loginPassword" type="password" placeholder="Password" style="padding: 5px; margin: 5px;" />
        <button onclick="login()"
            style="padding: 5px 15px; background: #28a745; color: white; border: none;">Login</button>
        <div id="loginStatus"></div>
    </div>
    <div style="background: #f0f0f0; padding: 15px; border-radius: 10px; margin: 20px 0;">
        <label>ğŸ‘¤ Name: <input id="usernameInput" placeholder="Student1" style="padding: 5px;" /></label>
        <label style="margin-left: 20px;">
            ğŸ“š Class:
            <select id="roomSelect" style="padding: 5px;">
                <option value="class_101">Class 101 (Math)</option>
                <option value="class_102">Class 102 (Science)</option>
                <option value="class_103">Class 103 (English)</option>
            </select>
        </label>
        <button onclick="joinRoom()"
            style="padding: 5px 15px; background: #007bff; color: white; border: none; border-radius: 5px;">Join
            Class</button>
    </div>

    <div id="currentRoom"></div>
    <div id="userList" style="color: #666;"></div>

    <div style="margin: 20px 0;">
        <input id="messageInput" placeholder="Type message..." style="width: 70%; padding: 10px;" />
        <button onclick="sendMessage()"
            style="width: 28%; padding: 10px; background: #28a745; color: white; border: none;">Send</button>
    </div>

    <ul id="messages"
        style="list-style: none; padding: 0; max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
    </ul>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        let authToken = null;
        let socket = null;  // ğŸ”¥ FIXED: Don't connect yet
        let currentRoom = null;

        // ğŸ”¥ FIXED: Connect ONLY after login
        async function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            const response = await fetch('/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });

            const data = await response.json();
            if (data.success) {
                authToken = data.token;
                document.getElementById('loginStatus').innerHTML = `âœ… Logged in as ${data.username}`;

                // ğŸ”¥ CONNECT Socket AFTER getting token
                socket = io({ auth: { token: authToken } });
                setupSocketEvents();  // ğŸ”¥ NOW setup events
                console.log('ğŸ”— Socket connecting with token...');
            } else {
                document.getElementById('loginStatus').innerHTML = `âŒ ${data.error}`;
            }
        }

        function setupSocketEvents() {
            socket.on('connect', () => {
                console.log('âœ… Socket connected!');
            });

            socket.on('chat-message', (data) => {
                if (data.roomId === currentRoom) {
                    const li = document.createElement('li');
                    li.style.margin = '5px 0';
                    li.innerHTML = `<strong style="color: #007bff;">${data.username}:</strong> ${data.message}`;  // ğŸ”¥ FIXED: data.username
                    document.getElementById('messages').appendChild(li);
                    li.scrollIntoView();
                }
            });

            socket.on('room-users', (data) => {
                if (data.roomId === currentRoom) {
                    document.getElementById('userList').innerHTML = `ğŸ‘¥ ${data.userCount} students/teachers online`;
                }
            });

            socket.on('chat-history', (messages) => {
                const messagesList = document.getElementById('messages');
                messagesList.innerHTML = '';
                messages.forEach(msg => {
                    const li = document.createElement('li');
                    li.style.margin = '5px 0';
                    li.innerHTML = `<strong style="color: #007bff;">${msg.username}:</strong> ${msg.message}`;  // ğŸ”¥ FIXED: msg.username
                    messagesList.appendChild(li);
                });
            });
        }

        function joinRoom() {
            if (!authToken || !socket) {
                alert('Please login first!');
                return;
            }
            currentRoom = document.getElementById('roomSelect').value;
            socket.emit('join-room', currentRoom);
            document.getElementById('currentRoom').innerHTML = `<h3>ğŸ“š In: ${currentRoom}</h3>`;
        }

        function sendMessage() {
            if (!socket || !currentRoom) {
                alert('Please login and join a room first!');
                return;
            }
            const input = document.getElementById('messageInput');
            const username = document.getElementById('usernameInput').value || 'Anonymous';  // ğŸ”¥ FIXED: consistent naming
            const msg = input.value;
            if (msg && currentRoom) {
                socket.emit('chat-message', {
                    message: msg,
                    roomId: currentRoom,
                    username  // ğŸ”¥ FIXED: send username (not userName)
                });
                input.value = '';
            }
        }
    </script>

</body>

</html>